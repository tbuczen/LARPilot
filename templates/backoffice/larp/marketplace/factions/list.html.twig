{% extends 'backoffice/larp/marketplace/_base.html.twig' %}

{% set active_tab = 'factions' %}

{% block marketplace_content %}
    {% include 'includes/filter_form.html.twig' with { form: filterForm } %}

    {% if factions is not empty %}
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>{{ 'common.title'|trans }}</th>
                        <th>{{ 'common.description'|trans }}</th>
                        <th>{{ 'common.tags'|trans }}</th>
                        <th>{{ 'backoffice.marketplace.involved_story_objects'|trans }}</th>
                        <th>{{ 'common.actions'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for faction in factions %}
                        <tr>
                            <td>
                                <a href="{{ path('backoffice_larp_story_faction_modify', {
                                    larp: larp.id, faction: faction.id
                                }) }}">
                                    {{ faction.title }}
                                </a>
                            </td>
                            <td>{{ faction.description|sanitize_html|striptags|u.truncate(100, '...') }}</td>
                            <td>
                                {% for tag in faction.tags %}
                                    <span class="badge bg-info">{{ tag.title }}</span>
                                {% endfor %}
                            </td>
                            <td>
                                <div class="small">
                                    {% set hasContent = false %}

                                    {% if faction.threads|length > 0 %}
                                        {% set hasContent = true %}
                                        <div>
                                            <strong>{{ 'backoffice.marketplace.threads'|trans }}:</strong>
                                            <span class="badge bg-primary">{{ faction.threads|length }}</span>
                                            {% if faction.threads|length <= 3 %}
                                                <br>
                                                {% for thread in faction.threads %}
                                                    <span class="text-muted">{{ thread.title }}</span>{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    {% if faction.quests|length > 0 %}
                                        {% set hasContent = true %}
                                        <div class="{% if faction.threads|length > 0 %}mt-1{% endif %}">
                                            <strong>{{ 'backoffice.marketplace.quests'|trans }}:</strong>
                                            <span class="badge bg-success">{{ faction.quests|length }}</span>
                                            {% if faction.quests|length <= 3 %}
                                                <br>
                                                {% for quest in faction.quests %}
                                                    <span class="text-muted">{{ quest.title }}</span>{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    {# Note: Events don't have a direct collection on Faction, need to query via Event.involvedFactions #}
                                    {# This would require a custom repository method or eager loading in the controller #}

                                    {% if faction.members|length > 0 %}
                                        {% set hasContent = true %}
                                        <div class="{% if faction.threads|length > 0 or faction.quests|length > 0 %}mt-1{% endif %}">
                                            <strong>{{ 'common.characters'|trans }}:</strong>
                                            <span class="badge bg-info">{{ faction.members|length }}</span>
                                            {% if faction.members|length <= 3 %}
                                                <br>
                                                {% for member in faction.members %}
                                                    <span class="text-muted">{{ member.title }}</span>{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    {% if not hasContent %}
                                        <span class="text-muted">{{ 'backoffice.marketplace.no_story_objects'|trans }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <a href="{{ path('backoffice_larp_story_faction_modify', {
                                    larp: larp.id, faction: faction.id
                                }) }}" class="btn btn-sm btn-primary">
                                    {{ 'common.edit'|trans }}
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% include 'includes/pagination.html.twig' with { pagination: factions } %}
    {% else %}
        <p class="text-muted p-3">{{ 'common.empty_list'|trans }}</p>
    {% endif %}
{% endblock %}
